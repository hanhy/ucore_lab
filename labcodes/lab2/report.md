# report 

## [练习 1] 实现first-fit连续物理内存分配算法(需要编程)
```
>仔细readdefault_pmm.c中的注释，其中已经给出了实现几个函数的具体过程。
default_init_memmap函数：
	首先设置每个块的属性和标志，并将其加入链表，然后空闲块的size加n（n是加进来的size），其中设置几个属性和标志时要注意：
	除了第一个空闲块是n外，其他的property都是0；
	设置每个块都是没有引用过的
	
default_alloc_pages
	按照first-fit原则进行分配，遍历链表找到第一个可以使用的空闲块重新计算它的大小，返回地址，实现细节：
	使用如下方式遍历“list_entry_t le = &free_list; while((le=list_next(le)) != &free_list)”
	在循环中，判断每一个块的大小是不是大于等于n，对这些块进行PG_reserved =1, PG_property =0的设置，从链表上面除去这些页。
	对于大于的部分还要计算剩下的块的大小，加进链表
	重新计算空闲空间的总大小，返回地址即可
default_free_pages
	根据释放内存的基地址，遍历链表，找到正确的位置（由低到高），插入其包含的页
	重新设置这些页的诸如引用、property之类的属性值，并且把释放的块跟前后相邻的空闲块合并起来。
	合并是本函数的重点。详细见代码注释。

```


## [练习2] 实现寻找虚拟地址对应的页表项(需要编程)
```
>根据注释的提示，先阅读pmm.h文件了解基本的宏的意义，然后按照后面所给的提示一步步实现代码
分为以下几个步骤：
	1、找到PDE
	2、检查entry是否存在
	3、检查是否创建了，然后为页表分配页
	4、设置引用值
	5、获取页的线性地址空间
	6、用memset函数进行页内容的初始化
	7、设置PDE的权限值
	8、返回
可见提示已经非常清楚，而且也符合课程中的介绍，在懂得如何运用相关函数和宏的情况下，我们不难写出代码（具体内容见代码相应位置）
思考题：
1、请描述页目录项(Pag Director Entry)和页表(Page Table Entry)中每个组成部分的含义和以及对ucore而言的潜在用处。
	以一个大小是4B的页表项/页目录项为例：
		31是存在位，表明是否存在该表项对应的页
		30是否可写
		29处于用户态的软件能否读取该页的内容
		28是否写直达
		27映射的页面是否被装入缓存
		26映射的页面是否正被访问
		25该页是否被修改过
		24、23固定为0
		22、21、20留给软件使用
		前20位代表被映射的页面的基地址
	
2、如果ucore执行过程中访问内存,出现了页访问异常,请问硬件要做哪些事情?
首先产生异常的线性地址会被储存在CR2寄存器中，由硬件给出出错码，并且指明异常的类型
因为之后可能还会恢复，所以发生异常的时候需要保留程序的运行状态，将其相关参数压入栈中待用
加载中断号0xe的中断服务例程的地址，存在CS和EIP寄存器里面
操作系统执行中断服务例程处理异常，之后恢复。
前面三个步骤基本上都是由硬件完成的。
```
## [练习3] 释放某虚地址所在的页并取消对应二级页表项的映射(需要编程)
>阅读注释，本例十分简单，只需要经过检查相应属性，在合适的时候释放掉表项就可以了，分为以下几步
    1、检测页表项是否存在
    2、获取ptep对应的页
    3、引用值减小，如果为0就释放该页
    4、第二个页表项清零
    5、清空TLB
在lab2下执行 make qemu，看到如下现象：
		...
		check_alloc_page() succeeded!
		check_pgdir() succeeded!
		check_boot_pgdir() succeeded!
		-------------------- BEGIN --------------------
		PDE(0e0) c0000000-f8000000 38000000 urw
		  |-- PTE(38000) c0000000-f8000000 38000000 -rw
		PDE(001) fac00000-fb000000 00400000 -rw
		  |-- PTE(000e0) faf00000-fafe0000 000e0000 urw
		  |-- PTE(00001) fafeb000-fafec000 00001000 -rw
		--------------------- END ---------------------
		++ setup timer interrupts
		100 ticks...
	至此，lab2实验结束。  
思考题：
1、数据结构Page的全局变量(其实是一个数组)的每一项与页表中的页目录项和页表项有无对应关系?如果有,其对应关
系是啥?
有
	第二题中已经有分析过页表中页目录项和页表项每个位的具体意义，前二十位代表被映射的页面的基地址（需要经过移位）
	还有许多跟对应页面相关的标志位
2、如果希望虚拟地址与物理地址相等,则需要如何修改lab2,完成此事?	鼓励通过编程来具体完成这个问题
	只需要更改映射关系，比如gdt_init涉及到映射关系，可以对其进行相应的修改。

























